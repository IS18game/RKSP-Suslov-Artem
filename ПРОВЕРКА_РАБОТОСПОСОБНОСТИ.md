# Проверка работоспособности системы

## Шаг 1: Запуск инфраструктуры

```powershell
cd processor-service
docker-compose up -d
```

**Проверка:**
```powershell
docker ps
```

Должны быть запущены 3 контейнера:
- postgres
- clickhouse  
- rabbitmq

## Шаг 2: Запуск сервисов

**Терминал 1 - Ingest Service:**
```powershell
cd ingest-service
mvn spring-boot:run
```

Дождитесь сообщения: `Started SuslovApplication`

**Терминал 2 - Processor Service:**
```powershell
cd processor-service
mvn spring-boot:run
```

Дождитесь сообщения: `Started SuslovApplication` и `Таблица агрегаты_событий_заказов создана/проверена в ClickHouse`

## Шаг 3: Проверка доступности сервисов

**Ingest Service:**
- Откройте: http://localhost:8080/swagger-ui/index.html
- Должен открыться Swagger UI

**Processor Service:**
- Откройте: http://localhost:8081/swagger-ui/index.html
- Должен открыться Swagger UI

## Шаг 4: Отправка тестового события

**Через Swagger UI (рекомендуется):**
1. Откройте http://localhost:8080/swagger-ui/index.html
2. Найдите POST `/api/v1/events`
3. Нажмите "Try it out"
4. Вставьте JSON:
```json
{
  "идентификатор": "test-001",
  "номерЗаказа": "ORD-001",
  "номерТелефонаПокупателя": "+79991234567",
  "описаниеЗаказа": "Тестовый заказ",
  "датаСобытия": "2026-01-15T22:00:00"
}
```
5. Нажмите "Execute"

**Ожидаемый результат:** `"Event sent to RabbitMQ"`

## Шаг 5: Проверка обработки события

**В логах processor-service должны появиться:**
```
=== Начало обработки события ===
Получено событие из RabbitMQ:
  - Номер заказа: ORD-001
  - Телефон: +79991234567
Сохранение в PostgreSQL...
✓ Событие успешно сохранено в PostgreSQL!
  - ID: 1
  - Номер заказа: ORD-001
=== Конец обработки события ===
```

## Шаг 6: Проверка данных в PostgreSQL

**Через DBeaver:**
1. Подключитесь к PostgreSQL (localhost:5432, postgres/postgres)
2. Выполните: `SELECT * FROM сырые_события_заказов;`
3. Должна появиться запись с отправленным событием

## Шаг 7: Проверка RabbitMQ

1. Откройте http://localhost:15672 (guest/guest)
2. Перейдите в Queues → `events.raw`
3. Проверьте:
   - **Consumers:** должно быть 1 (processor-service подключен)
   - **Ready:** должно быть 0 (сообщение обработано)

## Шаг 8: Сохранение количества в ClickHouse

**Через Swagger UI:**
1. Откройте http://localhost:8081/swagger-ui/index.html
2. Найдите POST `/api/v1/events/count`
3. Нажмите "Try it out" → "Execute"

**Ожидаемый результат:** 
```json
{
  "count": 1,
  "message": "Count saved to ClickHouse"
}
```

## Шаг 9: Проверка данных в ClickHouse

1. Откройте http://localhost:8123/play
2. Выполните:
```sql
SELECT * FROM `агрегаты_событий_заказов` ORDER BY `дата_и_время_записи` DESC;
```

Должна появиться запись с количеством событий.

## Что проверить, если что-то не работает:

### События не обрабатываются:
1. Проверьте логи processor-service на наличие ошибок
2. Проверьте RabbitMQ Management → Queues → `events.raw` → Consumers (должно быть 1)
3. Убедитесь, что оба сервиса запущены

### Данные не появляются в PostgreSQL:
1. Проверьте логи processor-service
2. Убедитесь, что таблица создана в PostgreSQL
3. Попробуйте отправить новое событие

### ClickHouse не работает:
1. Проверьте, что контейнер запущен: `docker ps`
2. Создайте таблицу вручную через http://localhost:8123/play (см. README.md)